<!DOCTYPE html>
<html lang="en" data-version="v1.0.2">
  <head>
    <title>GenieBlocks LoRaWAN OTAA</title>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <link rel="icon" href="assets/genieblocks-logo.png" type="image/png">
    <link rel="stylesheet" href="css/style.css">
    <script type="module" src="js/script.js?v=1.0.2" defer></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.7.1/jquery.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery.inputmask/5.0.9/jquery.inputmask.min.js"></script>
    <script src="https://unpkg.com/imask"></script>
  </head>
  <body>
    <div id="notSupported" class="notSupported" style="display:none;">
      <div class="bt-warning">
        <span class="bt-warning-icon">&#9888;</span>
        <div class="bt-warning-content">
          <strong>Bu tarayıcı Web Bluetooth API desteği sunmuyor.</strong><br>
          Lütfen Bluetooth ile cihaz konfigürasyonu yapmak için <b>Google Chrome</b> veya Web Bluetooth destekleyen bir tarayıcı kullanın.<br>
          <span style="font-size:0.95em; color:#666;">(Mobilde: Chrome, Android WebView veya Samsung Internet; Masaüstünde: Chrome, Edge, Opera)</span>
        </div>
      </div>
    </div>
    <header class="main-header">
      <img src="assets/genieblocks-logo.png" class="GenieBlocks-Logo">
      <h1>Enerji Analizörü – Kablosuz Veri Okuma</h1>
    </header>
    <main class="main-content">
      <div class="connection-bar" style="display:flex;align-items:center;justify-content:space-between;margin-bottom:18px;">
        <span id="connection-status" class="status disconnected">Bağlı Değil</span>
        <button id="butConnect" type="button">Cihaza Bağlan</button>
      </div>

      <!-- Modern, minimal tab menüsü (LoRaWAN sekmesi gizli – gerektiğinde geri açılabilir) -->
      <div class="tab-container-modern">
        <button class="tab-modern" data-tab="lorawan" style="display:none;">LoRaWAN</button>
        <button class="tab-modern active" data-tab="modbus">Modbus Ayarları</button>
        <button class="tab-modern" data-tab="manual-modbus">Manuel Modbus</button>
        <button class="tab-modern" data-tab="firmware">Firmware</button>
      </div>

      <div class="tab-content" id="tab-lorawan" style="display:none;">
        <form class="otaa-form" autocomplete="off" onsubmit="return false;">
          <div class="form-row">
            <label for="device_eui">Device EUI</label>
            <input type="text" id="device_eui" name="device_eui" autocomplete="off" disabled maxlength="16">
          </div>
          <div class="form-row">
            <label for="app_eui">APP EUI</label>
            <input type="text" id="app_eui" name="app_eui" autocomplete="off" disabled maxlength="16">
          </div>
          <div class="form-row">
            <label for="app_key">APP Key</label>
            <input type="text" id="app_key" name="app_key" autocomplete="off" disabled maxlength="32">
          </div>
          <div class="form-row">
            <label for="platform">Platform</label>
            <input type="text" id="platform" name="platform" autocomplete="off" disabled>
          </div>
          <div class="form-row">
            <label for="freq">Freq</label>
            <input type="text" id="freq" name="freq" autocomplete="off" disabled>
          </div>
          <div class="form-row">
            <label for="pckpo">PckPo</label>
            <input type="text" id="pckpo" name="pckpo" autocomplete="off" disabled>
          </div>
          <div class="form-row">
            <label for="adr">ADR</label>
            <input type="text" id="adr" name="adr" autocomplete="off" disabled>
          </div>
        </form>
      </div>
      <div class="tab-content" id="tab-modbus">
        <p class="tab-description">Enerji analizörüne bağlanmak için Modbus RTU hattı ayarları.</p>
        <form class="otaa-form" autocomplete="off" onsubmit="return false;">
          <div class="form-row"><label for="mb_addr">Addr</label><input type="number" id="mb_addr" disabled></div>
          <div class="form-row"><label for="mb_baud">Baud</label><input type="text" id="mb_baud" disabled></div>
          <div class="form-row"><label for="mb_parity">Parity</label><input type="number" id="mb_parity" disabled></div>
          <div class="form-row"><label for="mb_stopbits">StopBits</label><input type="number" id="mb_stopbits" disabled></div>
          <div class="form-row"><label for="mb_databits">DataBits</label><input type="number" id="mb_databits" disabled></div>
          <div class="form-row"><label for="mb_timeout">Timeout</label><input type="text" id="mb_timeout" disabled></div>
          <div class="form-row"><label for="mb_polling">Polling</label><input type="text" id="mb_polling" disabled></div>
          <div class="form-row"><label for="mb_func">Func</label><input type="number" id="mb_func" disabled></div>
          <div class="form-row"><label for="mb_regstart">Reg Start</label><input type="number" id="mb_regstart" disabled></div>
          <div class="form-row"><label for="mb_reglen">Reg Len</label><input type="number" id="mb_reglen" disabled></div>
        </form>
      </div>

      <div class="tab-content" id="tab-manual-modbus" style="display:none;">
        <p class="tab-description">Bağlı cihaz üzerinden Modbus okuma/yazma isteği gönderin. (Query/Response GATT karakteristikleri)</p>
        <div class="manual-modbus-form">
          <div class="form-row">
            <label for="mm_slave">Slave Adresi</label>
            <input type="number" id="mm_slave" min="1" max="247" value="1" placeholder="1–247">
          </div>
          <div class="form-row">
            <label for="mm_func">Fonksiyon</label>
            <select id="mm_func">
              <option value="3">0x03 – Read Holding Registers</option>
              <option value="4">0x04 – Read Input Registers</option>
              <option value="6">0x06 – Write Single Register</option>
              <option value="16">0x10 – Write Multiple Registers</option>
            </select>
          </div>
          <div class="form-row">
            <label for="mm_start">Başlangıç Adresi</label>
            <input type="number" id="mm_start" min="0" max="65535" value="0" placeholder="0–65535">
          </div>
          <div class="form-row" id="mm_qty_row">
            <label for="mm_qty">Register Sayısı</label>
            <input type="number" id="mm_qty" min="1" max="64" value="1" placeholder="1–64">
          </div>
          <div class="form-row" id="mm_write_single_row" style="display:none;">
            <label for="mm_value_single">Değer (1 register)</label>
            <input type="text" id="mm_value_single" placeholder="0–65535 veya 0x0000" value="0">
          </div>
          <div class="form-row" id="mm_write_multi_row" style="display:none;">
            <label for="mm_value_multi">Değerler (virgülle ayırın)</label>
            <input type="text" id="mm_value_multi" placeholder="örn. 100, 200, 0x1234">
          </div>
          <div class="manual-modbus-actions">
            <button type="button" id="mm_btn_read" disabled>Modbus Oku</button>
            <button type="button" id="mm_btn_write" disabled>Modbus Yaz</button>
          </div>
          <div class="manual-modbus-result">
            <div class="result-header">Sonuç</div>
            <div id="mm_result_status" class="result-status">—</div>
            <div id="mm_result_data" class="result-data"></div>
          </div>
        </div>
      </div>

      <div class="tab-content" id="tab-firmware" style="display:none;" class="tab-pane">
        <form class="firmware-form">
            <div class="firmware-header">
                <h3>Firmware Güncelleme</h3>
                <div class="firmware-info">Cihazın firmware'ini güncellemek için .bin uzantılı dosya seçin.</div>
            </div>
            
            <div class="firmware-controls">
                <div class="file-input-container">
                    <input type="file" id="firmware-file" accept=".bin" disabled>
                    <label for="firmware-file" class="file-input-label">
                        <svg width="20" height="20" viewBox="0 0 20 20" fill="none">
                            <path d="M10 1v14M4 9l6-6 6 6" stroke="currentColor" stroke-width="2" stroke-linecap="round"/>
                            <path d="M3 15v2h14v-2" stroke="currentColor" stroke-width="2" stroke-linecap="round"/>
                        </svg>
                        Firmware Dosyası Seç (.bin)
                    </label>
                </div>
                
                <div class="firmware-details" style="display: none;">
                    <div class="detail-row">
                        <span class="detail-label">Dosya:</span>
                        <span id="firmware-filename" class="detail-value">-</span>
                    </div>
                    <div class="detail-row">
                        <span class="detail-label">Boyut:</span>
                        <span id="firmware-size" class="detail-value">-</span>
                    </div>
                </div>
                
                <div class="progress-container" style="display: none;">
                    <div class="progress-header">
                        <span>Yükleme Durumu</span>
                        <span class="progress-text">%0</span>
                    </div>
                    <div class="progress-bar">
                        <div class="progress" style="width: 0%"></div>
                    </div>
                </div>
                
                <div class="firmware-actions">
                    <button type="button" id="start-upload" class="primary-button" disabled>
                        <svg width="16" height="16" viewBox="0 0 16 16" fill="none">
                            <path d="M8 1v11m-4-4l4 4 4-4" stroke="currentColor" stroke-width="2" stroke-linecap="round"/>
                            <path d="M2 13v1h12v-1" stroke="currentColor" stroke-width="2" stroke-linecap="round"/>
                        </svg>
                        Yüklemeyi Başlat
                    </button>
                    <button type="button" id="cancel-upload" class="danger-button" disabled>
                        <svg width="16" height="16" viewBox="0 0 16 16" fill="none">
                            <path d="M3 3l10 10m-10 0l10-10" stroke="currentColor" stroke-width="2" stroke-linecap="round"/>
                        </svg>
                        İptal
                    </button>
                </div>
                <div class="firmware-timer"><span id="firmware-timer-label">Süre:</span> <span id="firmware-timer-value">00:00</span></div>
            </div>
            
            <div class="firmware-log">
                <div class="log-header">
                    <span>İşlem Kayıtları</span>
                    <button type="button" id="clear-firmware-log" class="text-button">
                        <svg width="16" height="16" viewBox="0 0 16 16" fill="none">
                            <path d="M2 4h12M5 4V2h6v2M4 6v8h8V6" stroke="currentColor" stroke-width="1.5" stroke-linecap="round"/>
                        </svg>
                        Temizle
                    </button>
                </div>
                <div id="firmware-log-content"></div>
            </div>
        </form>
    </div>

      <div class="form-row" style="display: flex; align-items: center; gap: 8px; margin-top: 18px;">
        <button id="write_all" disabled>Yaz</button>
        <button id="read_all" type="button" disabled>Oku</button>
        <div style="flex:1"></div>
        <button id="commit_and_restart" type="button" disabled style="margin-left:auto;">Cihazı Yeniden Başlat</button>
      </div>

      <div style="margin-top:18px;text-align:right;">
        <button id="toggleLog">Logu Göster/Gizle</button>
      </div>
      <div id="log" class="log-area"></div>
    </main>
                            <div class="app-version">v1.0.2</div>
  </body>
</html>
